{% extends "base.html" %}
{% block title %}Company â€“ {{ company.basic_info.company_name or 'Details' }}{% endblock %}


{% block content %}

<div id="company-page" class="{% if locked %}content-blurred{% endif %}">

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  .map-container {
    width: 100%;
    height: 320px;          /* must have a height */
    border-radius: 12px;
    overflow: hidden;
    background: #f3f4f6;
  }
</style>
{% endblock %}

<!-- Hero heading (same component used by category.html) -->
<div class="page-heading">
  <div class="container">
    <div class="row">
      <div class="col-lg-10">
        <div class="top-text header-text">
          <h6>Company details</h6>
          <h2>{{ company.basic_info.company_name }}</h2>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabs (use the naccs markup from category.html) -->
<div class="category-post">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">

        <div class="naccs">
          <div class="grid">
            <div class="row">
              <div class="col-lg-12">
                <!-- MENU -->
                <div class="menu">
                  <div class="first-thumb active">
                    <div class="thumb">
                      <span class="icon">
                        <img src="{{ url_for('static', filename='img/overview-icon.png') }}" style="max-width: 75%;height: auto;" alt="">
                        <h4>Overview</h4>
                      </span>
                    </div>
                  </div>
                  <div>
                    <div class="thumb">
                      <span class="icon">
                        <img src="{{ url_for('static', filename='img/location-icon.png') }}" style="max-width: 75%;height: auto;" alt="">
                        <h4>Location</h4>
                      </span>
                    </div>
                  </div>
                  <div>
                    <div class="thumb">
                      <span class="icon">
                        <img src="{{ url_for('static', filename='img/management-icon.png') }}" style="max-width: 95%;height: auto;" alt="">
                        <h4>Management</h4>
                      </span>
                    </div>
                  </div>
                  <div>
                    <div class="thumb">
                      <span class="icon">
                        <img src="{{ url_for('static', filename='img/financial-icon.png') }}" style="max-width: 100%;height: auto;" alt="">
                        <h4>Financial</h4>
                      </span>
                    </div>
                  </div>
                  <div class="last-thumb">
                    <div class="thumb">
                      <span class="icon">
                        <img src="{{ url_for('static', filename='img/history-icon.jpg') }}" style="max-width: 65%;height: auto;" alt="">
                        <h4>History</h4>
                      </span>
                    </div>
                  </div>
                </div>
                <!-- /MENU -->
              </div>

              <div class="col-lg-12">
                <!-- PANES -->
                <ul class="nacc">
                  <!-- Overview -->
                  <li class="active">
                    <div>
                      <div class="thumb">
                        <div class="row" style="margin-top:35px ;">
                          <div class="col-lg-12">
                            <div class="description">
                              <div class="row">
                                <div class="col-lg-12">
                                  <p><strong>Company Name:</strong> {{ company.basic_info.company_name }}</p>
                                  <p><strong>Legal Form:</strong> {{ company.basic_info.legal_form }}</p>
                                  <p><strong>Company Number:</strong> {{ company.basic_info.company_number }}</p>
                                  <p><strong>European ID:</strong> {{ company.basic_info.european_id }}</p>
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </li>

                  <!-- Location -->
                  <li>
                    <div>
                      <div class="thumb">
                        <div class="row" style="margin-top:35px;">
                          <div class="col-lg-12">
                            <div class="description">
                              <div class="row">
                                <div class="col-lg-12">
                                  {# --- Normalize and format address --- #}
                                  {% set raw_street = company.location.street %}
                                  {% if raw_street is sequence and (raw_street is not string) %}
                                    {% set street = raw_street | select | join(' ') %}
                                  {% else %}
                                    {% set street = raw_street %}
                                  {% endif %}

                                  {# Convert AUT -> Austria etc. for Nominatim reliability #}
                                  {% set c3map = {
                                    'AUT':'Austria',
                                    'DEU':'Germany',
                                    'CHE':'Switzerland',
                                    'ITA':'Italy',
                                    'SVK':'Slovakia',
                                    'HUN':'Hungary',
                                    'CZE':'Czechia'
                                  } %}
                                  {% set country_name = c3map.get(company.location.country, company.location.country) %}

                                  {# Create well-formatted comma-separated address string #}
                                  {% set address = (
                                    (street ~ ' ' ~ company.location.house_number)|trim ~ ', ' ~
                                    (company.location.postal_code ~ ' ' ~ company.location.city)|trim ~ ', ' ~
                                    country_name
                                  ) | trim %}

                                  {# --- Display details --- #}
                                  <p><strong>Address:</strong> {{ address }}</p>

                                  <!-- Interactive Map -->

                                  <!-- Google Maps Redirect -->
                                  <div class="mt-2">
                                    <a class="btn btn-light"
                                      target="_blank"
                                      href="https://www.google.com/maps/search/?api=1&query={{ address|urlencode }}">
                                      Open in Google Maps
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>


                  <!-- Management -->
                  <li>
                    <div>
                      <div class="thumb">
                        <div class="row" style="margin-top:35px ;"  >
                          <div class="col-lg-12">
                            <div class="description">
                              <div class="row" >
                                <div class="col-lg-12">
                                  {% set managers = company.management or [] %}
                                  {% if managers %}
                                    {% for m in managers %}
                                      <div class="mb-3">
                                        <p><strong>Name:</strong> {{ m.name }}</p>
                                        <p><strong>Role:</strong> {{ m.role }}</p>
                                        <p><strong>Appointed:</strong> {{ m.appointed_on }}</p>
                                      </div>
                                    {% endfor %}
                                  {% else %}
                                    <p>No management records available.</p>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </div>


                        </div>
                      </div>
                    </div>
                  </li>

                  <!-- Financial -->
                  <li>
                    <div>
                      <div class="thumb">
                        <div class="row" style="margin-top:35px ;" >
                          <div class="col-lg-12">
                            <div class="description">
                              <div class="row">
                                <div class="col-lg-12">
                                  <p><strong>Director:</strong> {{ company.financial.director_name }}</p>
                                  <p><strong>Total Assets:</strong> {{ company.financial.total_assets }}</p>
                                </div>
                              </div>
                            </div>
                          </div>

                          

                        </div>
                      </div>
                    </div>
                  </li>

                  <!-- History -->
                  <li>
                    <div>
                      <div class="thumb">
                        <div class="row" style="margin-top:35px ;">
                          <div class="col-lg-12">
                            <div class="description">
                              <div class="row">
                                <div class="col-lg-12">
                                  {% set events = company.history or [] %}
                                  {% if events %}
                                    {% for e in events %}
                                      <div class="mb-3">
                                        <p><strong>Date:</strong> {{ e.event_date }}</p>
                                        <p><strong>Event:</strong> {{ e.event }}</p>
                                        <p><strong>Court:</strong> {{ e.court }}</p>
                                      </div>
                                    {% endfor %}
                                  {% else %}
                                    <p>No history available.</p>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
                <!-- /PANES -->
              </div>

            </div>
          </div>
        </div>

      </div><!-- /col -->
    </div><!-- /row -->
  </div><!-- /container -->
</div><!-- /category-post -->

</div>

{% if locked %}
  <div class="locked-overlay">
    <div class="locked-card">
      <h4 class="mb-2">Login Required</h4>
      <p class="mb-3">Please log in to view full company details.</p>
      <a class="btn btn-dark w-100"
         href="{{ url_for('main.login', next=login_next or request.full_path) }}">
        Go to Login
      </a>
    </div>
  </div>
{% endif %}

{% endblock %}

